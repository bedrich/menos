#!/usr/bin/env node

var less = require('less');
var fs = require('fs');

// Does file exist?
fs.stat(process.argv[2], function(err, stats) {
	if (err) {
		console.error('✖ ' + process.argv[2] + ' was not found.', err);
	} else {
		main(process.argv[2]);
	}
});

function main (filename) {
	var manifest;

	try {
		manifest = JSON.parse(fs.readFileSync(filename, 'utf-8'));
	} catch (e) {
		console.error(e);
	}

	if (process.argv[3] === '--watch') {
		watchLess(manifest);
	} else {
		parseLess(manifest);
	}
}

function watchLess (manifest) {
	// Watch multiple files
}

function parseLess (settings) {
	var parser = new (less.Parser)({ 'paths': [settings.paths.less] });
	var opts = { 'compress': false };
	var cssPath = settings.paths.css;
	var cssFile;
	var lessFile;
	var lessBody;

	if (settings.compress) {
		cssPath = settings.paths.min;
		opts = { compress: true };
	}

	for (var i = 0, len = settings.files.length; i < len; i++) {
		lessFile = settings.paths.less + settings.files[i]['less'] + '.less';
		lessBody = fs.readFileSync(lessFile, 'utf-8');
		cssFile = cssPath + settings.files[i]['css'] + '.css';

		parser.parse(lessBody, function (err, tree) {
			if (err) {
				return console.error(err);
			} else {
				console.log('★ [' + lessFile + '] was successfully parsed.')
				fs.writeFileSync(cssFile, tree.toCSS(opts));
			}
		});
	}
}